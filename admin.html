<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Access</title>
</head>
<body>

<h2>Checking accessâ€¦</h2>

<script>
(async function(){

  const params = new URLSearchParams(location.search);
  const token = params.get("token");

  if(!token){
    document.body.innerHTML = "â›” Invalid or missing token";
    return;
  }

  // ğŸ” device fingerprint
  const raw = navigator.userAgent +
              screen.width +
              screen.height +
              navigator.language;

  const buffer = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(raw)
  );

  const deviceHash = Array.from(new Uint8Array(buffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");

  const lockKey = "posko_token_lock_" + token;
  const lockedDevice = localStorage.getItem(lockKey);

  // ğŸ”“ first open â†’ lock + redirect
  if(!lockedDevice){
    localStorage.setItem(lockKey, deviceHash);
    window.location.href = "./?token=" + token;
    return;
  }

  // âŒ different device
  if(lockedDevice !== deviceHash){
    document.body.innerHTML =
      "â›” This link is already locked to another device";
    return;
  }

  // âœ… same device â†’ redirect again
  window.location.href = "./?token=" + token;

})();
</script>

</body>
</html>

